<template>
  <div class="grid m-0 h-full">
    <header class="col-2 flex flex-column">
      <svg
        class="image mx-1 mt-2"
        xmlns="http://www.w3.org/2000/svg"
        style="width: 55%"
        viewBox="0 0 110 50"
        fill="none"
        transform="matrix(1, 0, 0, 1, 0, 0)"
      >
        <circle
          cx="23.3689"
          cy="28.8558"
          r="17.0103"
          stroke="#ffffff"
          stroke-width="2.26804"
          fill="#ffffff"
        />
        <path
          d="M57.8884 46.1291C56.3737 46.1291 55.0105 45.8362 53.7988 45.2506C52.5871 44.6649 51.5975 43.8874 50.8301 42.918L51.6177 42.2213C53.2535 44.2206 55.3438 45.2203 57.8884 45.2203C58.9991 45.2203 59.9584 45.0789 60.7662 44.7962C61.574 44.4932 62.1799 44.1095 62.5838 43.645C62.9877 43.1603 63.2806 42.6757 63.4623 42.191C63.6441 41.6861 63.735 41.1711 63.735 40.646C63.735 39.616 63.432 38.7577 62.8262 38.0711C62.2203 37.3643 61.463 36.8594 60.5542 36.5564C59.6454 36.2535 58.6558 35.9405 57.5854 35.6174C56.5353 35.274 55.5558 34.9509 54.647 34.648C53.7382 34.3248 52.9809 33.7998 52.375 33.0727C51.7692 32.3457 51.4662 31.447 51.4662 30.3766C51.4662 28.8014 52.0822 27.5493 53.3141 26.6203C54.546 25.6913 56.0405 25.2268 57.7975 25.2268C60.6249 25.2268 62.806 26.176 64.3408 28.0744L63.5835 28.7711C62.2304 27.0141 60.3017 26.1356 57.7975 26.1356C56.303 26.1356 55.0509 26.5395 54.0412 27.3473C53.0314 28.1349 52.5265 29.1447 52.5265 30.3766C52.5265 31.1441 52.7486 31.8004 53.1929 32.3457C53.6574 32.891 54.2431 33.3151 54.9499 33.618C55.677 33.9209 56.4747 34.2037 57.3431 34.4662C58.2317 34.7086 59.1102 34.9812 59.9786 35.2841C60.847 35.5669 61.6346 35.9102 62.3415 36.3141C63.0685 36.718 63.6542 37.2936 64.0985 38.0408C64.563 38.7678 64.7952 39.6362 64.7952 40.646C64.7952 41.2721 64.6841 41.888 64.462 42.4939C64.2398 43.0796 63.8864 43.6652 63.4017 44.2509C62.917 44.8164 62.2001 45.2708 61.2509 45.6141C60.3017 45.9574 59.1809 46.1291 57.8884 46.1291Z"
          fill="#ffffff"
        />
        <path
          d="M78.6746 46.1291C75.7867 46.1291 73.4642 45.1395 71.7072 43.1603C69.9502 41.161 69.0717 38.6669 69.0717 35.6779C69.0717 32.689 69.9502 30.205 71.7072 28.2258C73.4642 26.2265 75.7867 25.2268 78.6746 25.2268C81.5424 25.2268 83.8547 26.2265 85.6117 28.2258C87.3889 30.205 88.2775 32.689 88.2775 35.6779C88.2775 38.6669 87.3889 41.161 85.6117 43.1603C83.8547 45.1395 81.5424 46.1291 78.6746 46.1291ZM78.6746 45.2203C81.2394 45.2203 83.2994 44.3317 84.8544 42.5545C86.4296 40.7571 87.2173 38.4649 87.2173 35.6779C87.2173 32.8708 86.4296 30.5786 84.8544 28.8014C83.2994 27.0242 81.2394 26.1356 78.6746 26.1356C76.0896 26.1356 74.0196 27.0242 72.4645 28.8014C70.9095 30.5786 70.1319 32.8708 70.1319 35.6779C70.1319 38.4649 70.9095 40.7571 72.4645 42.5545C74.0196 44.3317 76.0896 45.2203 78.6746 45.2203Z"
          fill="#ffffff"
        />
        <path d="M104.474 45.7656H93.356V25.56H94.3254V44.8568H104.474V45.7656Z" fill="#ffffff" />
        <path
          d="M57.8884 46.1291C56.3737 46.1291 55.0105 45.8362 53.7988 45.2506C52.5871 44.6649 51.5975 43.8874 50.8301 42.918L51.6177 42.2213C53.2535 44.2206 55.3438 45.2203 57.8884 45.2203C58.9991 45.2203 59.9584 45.0789 60.7662 44.7962C61.574 44.4932 62.1799 44.1095 62.5838 43.645C62.9877 43.1603 63.2806 42.6757 63.4623 42.191C63.6441 41.6861 63.735 41.1711 63.735 40.646C63.735 39.616 63.432 38.7577 62.8262 38.0711C62.2203 37.3643 61.463 36.8594 60.5542 36.5564C59.6454 36.2535 58.6558 35.9405 57.5854 35.6174C56.5353 35.274 55.5558 34.9509 54.647 34.648C53.7382 34.3248 52.9809 33.7998 52.375 33.0727C51.7692 32.3457 51.4662 31.447 51.4662 30.3766C51.4662 28.8014 52.0822 27.5493 53.3141 26.6203C54.546 25.6913 56.0405 25.2268 57.7975 25.2268C60.6249 25.2268 62.806 26.176 64.3408 28.0744L63.5835 28.7711C62.2304 27.0141 60.3017 26.1356 57.7975 26.1356C56.303 26.1356 55.0509 26.5395 54.0412 27.3473C53.0314 28.1349 52.5265 29.1447 52.5265 30.3766C52.5265 31.1441 52.7486 31.8004 53.1929 32.3457C53.6574 32.891 54.2431 33.3151 54.9499 33.618C55.677 33.9209 56.4747 34.2037 57.3431 34.4662C58.2317 34.7086 59.1102 34.9812 59.9786 35.2841C60.847 35.5669 61.6346 35.9102 62.3415 36.3141C63.0685 36.718 63.6542 37.2936 64.0985 38.0408C64.563 38.7678 64.7952 39.6362 64.7952 40.646C64.7952 41.2721 64.6841 41.888 64.462 42.4939C64.2398 43.0796 63.8864 43.6652 63.4017 44.2509C62.917 44.8164 62.2001 45.2708 61.2509 45.6141C60.3017 45.9574 59.1809 46.1291 57.8884 46.1291Z"
          stroke="#ffffff"
          stroke-width="0.907216"
          fill="#ffffff"
        />
        <path
          d="M78.6746 46.1291C75.7867 46.1291 73.4642 45.1395 71.7072 43.1603C69.9502 41.161 69.0717 38.6669 69.0717 35.6779C69.0717 32.689 69.9502 30.205 71.7072 28.2258C73.4642 26.2265 75.7867 25.2268 78.6746 25.2268C81.5424 25.2268 83.8547 26.2265 85.6117 28.2258C87.3889 30.205 88.2775 32.689 88.2775 35.6779C88.2775 38.6669 87.3889 41.161 85.6117 43.1603C83.8547 45.1395 81.5424 46.1291 78.6746 46.1291ZM78.6746 45.2203C81.2394 45.2203 83.2994 44.3317 84.8544 42.5545C86.4296 40.7571 87.2173 38.4649 87.2173 35.6779C87.2173 32.8708 86.4296 30.5786 84.8544 28.8014C83.2994 27.0242 81.2394 26.1356 78.6746 26.1356C76.0896 26.1356 74.0196 27.0242 72.4645 28.8014C70.9095 30.5786 70.1319 32.8708 70.1319 35.6779C70.1319 38.4649 70.9095 40.7571 72.4645 42.5545C74.0196 44.3317 76.0896 45.2203 78.6746 45.2203Z"
          stroke="#ffffff"
          stroke-width="0.907216"
          fill="#ffffff"
        />
        <path
          d="M104.474 45.7656H93.356V25.56H94.3254V44.8568H104.474V45.7656Z"
          stroke="#ffffff"
          stroke-width="0.907216"
          fill="#ffffff"
        />
        <circle cx="45.823" cy="6.40206" r="3.40206" fill="#4FB0EF" />
      </svg>
      <Divider />
      <nav class="navbar mx-1">
        <ul class="list-none p-0 m-0 overflow-hidden">
          <li>
            <a
              @click="backToDashboard"
              v-ripple
              class="flex align-items-center cursor-pointer p-3 border-round text-700 text-white hover p-ripple"
            >
              <i class="pi pi-th-large mr-2"></i>
              <span class="font-medium">Dashboard</span>
            </a>
          </li>
          <li>
            <a
              @click="goToListOfOrganizations"
              v-ripple
              :class="{ 'active-menu-item': isCurrentRoute('/list_of_organizations') }"
              class="flex align-items-center cursor-pointer p-3 border-round text-700 p-ripple"
            >
              <i class="pi pi-list mr-2"></i>
              <span class="font-medium">List of Organizations</span>
            </a>
          </li>
          <li>
            <a
              @click="osolbase"
              v-ripple
              class="flex align-items-center cursor-pointer p-3 border-round text-700 text-white hover p-ripple"
            >
              <i class="pi pi-server mr-2"></i>
              <span class="font-medium">List of O'Sol Base</span>
            </a>
          </li>
          <li>
            <a
              @click="goToListOfOsolPico"
              v-ripple
              class="flex align-items-center cursor-pointer p-3 border-round text-700 text-white hover p-ripple"
            >
              <i><font-awesome-icon class="mr-2" :icon="['far', 'hard-drive']" /></i>
              <span class="font-medium">List of O'Sol Pico</span>
            </a>
          </li>
          <li>
            <a
              @click="goToListOfUsers"
              v-ripple
              class="flex align-items-center cursor-pointer p-3 border-round text-700 text-white hover p-ripple"
            >
              <i class="pi pi-users mr-2"></i>
              <span class="font-medium">List of users</span>
            </a>
          </li>
          <li>
            <a
              @click="goToStatistics"
              v-ripple
              class="flex align-items-center cursor-pointer p-3 border-round text-700 p-ripple text-white"
              style="cursor: not-allowed; pointer-events: none; opacity: 0.2"
            >
              <i class="pi pi-th-large mr-2"></i>
              <span class="font-medium">Statistics</span>
            </a>
          </li>
          <li>
            <a
              @click="goToTickets"
              v-ripple
              class="flex align-items-center cursor-pointer p-3 border-round text-700 p-ripple text-white"
              style="cursor: not-allowed; pointer-events: none; opacity: 0.2"
            >
              <i class="pi pi-ticket mr-2"></i>
              <span class="font-medium">Tickets</span>
            </a>
          </li>
          <li class="alone">
            <a
              @click="goToLogin"
              v-ripple
              class="flex align-items-center cursor-pointer p-3 border-round text-700 text-white hover p-ripple"
            >
              <i class="pi pi-sign-out mr-2"></i>
              <span class="font-medium">Log Out</span>
            </a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="col-10">
      <div class="grid justify-content-between mx-5 mt-3">
        <h2>List of Organizations</h2>
        <Button
          class="my-2"
          label="Create a new organization"
          :class="$style.createorga"
          @click="makeorga = true"
          rounded
        />
        <Dialog
          v-model:visible="makeorga"
          maximizable
          modal
          header="Header"
          :style="{ width: '50rem' }"
          :breakpoints="{ '1199px': '75vw', '575px': '90vw' }"
        >
          <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
            incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud
            exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure
            dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
            Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt
            mollit anim id est laborum.
          </p>
        </Dialog>
      </div>
      <div class="grid justify-content-between mx-5 mt-3">
        <span class="p-input-icon-right">
          <AutoComplete
            multiple
            field="raisonSociale"
            :suggestions="filteredOrganizations"
            @complete="onAutocomplete"
            @select="onSuggestionSelect"
            v-model="selectedOrganizations"
            placeholder="Find an organization by name, manager, or e-mail"
            :class="$style.searchorga"
          />
          <i class="pi pi-search" />
        </span>
        <Button
          severity="secondary"
          label="Filters"
          icon="pi pi-sliders-h"
          :class="$style.filterstyle"
          @click="visible = true"
        />
        <Dialog
          v-model:visible="visible"
          maximizable
          modal
          header="Filters"
          :style="{ width: '50rem' }"
          :breakpoints="{ '1199px': '75vw', '575px': '90vw' }"
        >
          <div class="col">
            <div class="grid">
              <span>Filter by organization status</span>
            </div>
            <div class="grid mt-3 gap-2">
              <div class="col">
                <Checkbox v-model="active" inputId="filter1" name="active" value="Active" />
                <label for="filter1" class="ml-1"> Active </label>
                <Checkbox v-model="inactive" inputId="filter2" name="inactive" value="Inactive" />
                <label for="filter2" class="ml-1"> Inactive </label>
                <Checkbox v-model="deleted" inputId="filter3" name="deleted" value="Deleted" />
                <label for="filter3" class="ml-1"> Deleted </label>
              </div>
              <div class="col flex justify-content-end">
                <span
                  @click="clearFilters"
                  :style="{
                    opacity: isClearFiltersClicked ? 1 : 0.8,
                    fontWeight: isClearFiltersClicked ? 'bold' : 'normal'
                  }"
                  class="clear-filters"
                  >Clear all filters</span
                >
              </div>
            </div>
          </div>
        </Dialog>
      </div>
      <div class="grid mx-5 mt-3">
        <DataTable
          :value="selectedOrganizations.length > 0 ? selectedOrganizations : products"
          tableStyle="min-width: 50rem"
          :paginator="true"
          :rows="5"
          :rowsPerPageOptions="[1, 5, 10, 15, 20]"
        >
          <Column
            v-for="col of columns"
            :key="col.field"
            :field="col.field"
            :header="col.header"
          ></Column>
        </DataTable>
      </div>
    </main>
  </div>
</template>

<script setup lang="ts">
import { useRouter } from 'vue-router'
import axios from 'axios'
import { ref, onMounted } from 'vue'
const visible = ref(false)
const makeorga = ref(false)
const active = ref()
const inactive = ref()
const deleted = ref()
const value1 = ref(null)
const isClearFiltersClicked = ref(false)
const clearFilters = () => {
  // Vérifier si au moins une case à cocher est vraie.
  if (active.value || inactive.value || deleted.value) {
    active.value = false
    inactive.value = false
    deleted.value = false
    isClearFiltersClicked.value = true
    // Réinitialiser isClearFiltersClicked à false après un certain temps (par exemple, 3 secondes).
    setTimeout(() => {
      isClearFiltersClicked.value = false
    }, 1000) // Ajuster le temps selon les besoins (en millisecondes).
  } else {
    // Aucune case à cocher n'est cochée, ne rien faire
    isClearFiltersClicked.value = false
  }
}
onMounted(async () => {
  try {
    // requête API pour obtenir les données pico
    const response = await axios.get('http://localhost:8000/api/organisations')

    products.value = response.data
  } catch (error) {
    console.error('Erreur lors de la récupération des données API :', error)
  }
})

const products = ref()
const columns = [
  { field: 'raisonSociale', header: 'Organization name' },
  { field: 'email', header: 'E-mail' },
  { field: 'nombreBases', header: 'Bases' },
  { field: 'nombreBases', header: 'Status' },
  { field: 'nom_manager', header: "Manager's name" },
  { field: 'idOrganisation', header: 'Organization ID' }
]
const filteredOrganizations = ref([])
const selectedOrganizations = ref([]) // Utilisez un tableau pour stocker les organisations sélectionnées
const onAutocomplete = (event: { query: string }) => {
  //Effectuez une logique de filtrage en fonction de la valeur saisie.
  const query = event.query.toLowerCase()

  // Filtrez les organisations en fonction de la valeur saisie.
  filteredOrganizations.value = products.value.filter(
    (org: { raisonSociale: string; email: string; nom_manager: string }) => {
      return (
        org.raisonSociale.toLowerCase().includes(query) ||
        org.email.toLowerCase().includes(query) ||
        org.nom_manager.toLowerCase().includes(query)
      )
    }
  )
  // Réinitialiser filteredProducts si la requête est vide
  if (query === '') {
    filteredOrganizations.value = []
  }
}
const onSuggestionSelect = (event: { value: any }) => {
  // Mettez à jour l'état de sélection avec la nouvelle suggestion
  selectedOrganizations.value.push(event.value)
  // Effacez la valeur de l'AutoComplete pour permettre de sélectionner d'autres éléments
  value1.value = null
}
const router = useRouter()
// Fonction pour vérifier si la route actuelle correspond à un chemin spécifique
function isCurrentRoute(path: string): boolean {
  return router.currentRoute.value.path === path
}
function goToLogin() {
  window.location.href = '/login'
}
function goToListOfOrganizations() {
  window.location.href = '/list_of_organizations'
}
const osolbase = async () => {
  try {
    router.push('/list_of_osol_base')
  } catch (error) {
    console.error('Erreur de redirection :', error)
  }
}
function goToListOfOsolPico() {
  window.location.href = '/list_of_osol_pico'
}
function goToListOfUsers() {
  window.location.href = '/list_of_users'
}
function goToStatistics() {
  window.location.href = '/statistics'
}
function goToTickets() {
  window.location.href = '/tickets'
}
function backToDashboard() {
  window.location.href = '/dashboard'
}
</script>

<style module>
.createorga {
  background-color: #f6ce54;
  color: #40454e;
  padding-left: 1.5rem;
  padding-right: 1.5rem;
  border: none;
}
.filterstyle {
  background-color: #40454e;
  color: lightgrey;
}
.searchorga {
  width: 500px;
}
</style>

<style lang="css" scoped>
::v-deep(ul.p-autocomplete-multiple-container) {
  width: 100%;
}
::v-deep(.p-datatable .p-datatable-tbody > tr:hover) {
  background-color: #f6fbff;
}
::v-deep(.p-paginator .p-paginator-first) {
  color: #40454e;
}
::v-deep(.p-paginator .p-paginator-prev) {
  color: #40454e;
}
::v-deep(.p-paginator .p-paginator-next) {
  color: #40454e;
}
::v-deep(.p-paginator .p-paginator-last) {
  color: #40454e;
}
::v-deep(span.p-paginator-pages .p-highlight) {
  background-color: #40454e;
}
.active-menu-item {
  background-color: #f6ce54;
}
.clear-filters {
  cursor: pointer;
}

.clear-filters:hover {
  background-color: #f0f0f0;
}

.col-2 {
  background-color: #40454e;
  padding: 0;
  height: 100%;
}
.col-10 {
  padding: 0;
}

.alone {
  margin-top: 80%;
  padding-bottom: 11px;
}
.hover:hover {
  background-color: #f6ce54;
}
.hover:hover i,
font-awesome-icon,
.hover:hover span {
  color: #40454e;
}
a {
  font-size: 12px;
}
h2 {
  color: #40454e;
}
</style>
